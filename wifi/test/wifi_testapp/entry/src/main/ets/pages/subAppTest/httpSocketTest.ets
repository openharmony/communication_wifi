/**
 * Copyright (c) 2022 Shenzhen Kaihong Digital Industry Development Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import http from '@ohos.net.http';
import connection from '@ohos.net.connection';
import { TestData } from '../../entryability/model/testData'
import ConfigData from '../../utils/ConfigData';
import { BusinessError } from '@ohos.base';
import { TestImageDisplay } from '../../Component/testImageDisplay';
import { PageTitle } from '../../Component/pageTitle';
import router from '@ohos.router';

interface myParams extends Object {
  testItem: TestData
}
const TAG = 'wifiTestApp [httpSocketTest]';

/**
 * HTTP Test Page Of Wifi test
 */
@Entry
@Component
struct HttpSocketTest {
  private testItem: TestData = (router.getParams() as myParams).testItem
  @State selectIndex: number = 0;
  @State selectValue: string = 'GET';
  @State typeList: Array<SelectOption> = [
    { value: 'GET'},
    { value: 'POST'},
    { value: 'PUT'},
    { value: 'DELETE'},
    { value: 'TRACE'},
    { value: 'CONNECT'},
    { value: 'OPTIONS'}
  ];
  @State urlValue: string = 'http://www.baidu.com';
  @State reqSelectIndex: number = 0;
  @State reqSelectValue: string = 'none';
  @State reqTypeList: Array<SelectOption> = [
    { value: 'none'},
    { value: 'raw'}
  ];
  @State reqValue: string = '';
  @State resData: string = '';
  @State codeValue: string = '';
  @State isLoading: boolean = false;
  @State networkStatus: string = 'æ£€æµ‹ä¸­...';
  @State networkType: string = 'æœªçŸ¥';
  @State networkSwitchCount: number = 0;
  private netConnection: connection.NetConnection | null = null;

  aboutToAppear() {
    this.registerNetworkListener();
    this.checkCurrentNetwork();
  }

  // æ³¨å†Œç½‘ç»œç›‘å¬
  registerNetworkListener() {
    try {
      this.netConnection = connection.createNetConnection();
      
      // ç›‘å¬ç½‘ç»œåˆ‡æ¢
      this.netConnection.on('netAvailable', (netHandle: connection.NetHandle) => {
        console.log(TAG, `ç½‘ç»œåˆ‡æ¢: netId=${netHandle.netId}`);
        this.networkStatus = 'ç½‘ç»œå·²åˆ‡æ¢';
        this.networkSwitchCount++;
        this.resData += `\n\nâš ï¸ [ç³»ç»Ÿ] æ£€æµ‹åˆ°ç½‘ç»œåˆ‡æ¢ (ç¬¬${this.networkSwitchCount}æ¬¡)`;
        this.resData += '\nâš ï¸ [è­¦å‘Š] HTTPæ¨¡å—æ— Closeæ¥å£ï¼Œæ—§è¿æ¥å¯èƒ½æœªå…³é—­';
        this.resData += '\nğŸ’¡ [å»ºè®®] æ¨èä½¿ç”¨ RCP HTTPéªŒè¯ é¡µé¢è¿›è¡Œæµ‹è¯•';
      });

      this.netConnection.on('netCapabilitiesChange', (netCapabilityInfo: connection.NetCapabilityInfo) => {
        if (netCapabilityInfo.netCap) {
          this.updateNetworkType(netCapabilityInfo.netCap);
        }
      });

      this.netConnection.on('netLost', (netHandle: connection.NetHandle) => {
        console.log(TAG, `ç½‘ç»œä¸¢å¤±: netId=${netHandle.netId}`);
        this.networkStatus = 'ç½‘ç»œæ–­å¼€';
        this.resData += '\n[ç³»ç»Ÿ] ç½‘ç»œè¿æ¥ä¸¢å¤±';
      });

      this.netConnection.register((error: Error) => {
        if (error) {
          console.error(TAG, `æ³¨å†Œç½‘ç»œç›‘å¬å¤±è´¥: ${JSON.stringify(error)}`);
          this.networkStatus = 'ç›‘å¬æ³¨å†Œå¤±è´¥';
        } else {
          console.log(TAG, 'ç½‘ç»œç›‘å¬å·²æ³¨å†Œ');
        }
      });
    } catch (error) {
      console.error(TAG, `åˆ›å»ºç½‘ç»œç›‘å¬å¤±è´¥: ${JSON.stringify(error)}`);
      this.networkStatus = 'ç›‘å¬åˆ›å»ºå¤±è´¥';
    }
  }

  async checkCurrentNetwork() {
    try {
      const netHandle = await connection.getDefaultNet();
      const netCapabilities = await connection.getNetCapabilities(netHandle);
      this.updateNetworkType(netCapabilities);
      this.networkStatus = 'ç½‘ç»œæ­£å¸¸';
      console.log(TAG, `å½“å‰ç½‘ç»œç±»å‹: ${this.networkType}`);
    } catch (error) {
      console.error(TAG, `è·å–ç½‘ç»œçŠ¶æ€å¤±è´¥: ${JSON.stringify(error)}`);
      this.networkStatus = 'æ— ç½‘ç»œ';
      this.networkType = 'æœªè¿æ¥';
    }
  }

  updateNetworkType(netCapabilities: connection.NetCapabilities) {
    if (netCapabilities.bearerTypes.includes(connection.NetBearType.BEARER_WIFI)) {
      this.networkType = 'WiFi';
    } else if (netCapabilities.bearerTypes.includes(connection.NetBearType.BEARER_CELLULAR)) {
      this.networkType = 'èœ‚çªç½‘ç»œ';
    } else if (netCapabilities.bearerTypes.includes(connection.NetBearType.BEARER_ETHERNET)) {
      this.networkType = 'ä»¥å¤ªç½‘';
    } else {
      this.networkType = 'å…¶ä»–';
    }
  }

  aboutToDisappear() {
    // å–æ¶ˆç½‘ç»œç›‘å¬
    if (this.netConnection) {
      try {
        this.netConnection.unregister((error: Error) => {
          if (error) {
            console.error(TAG, `å–æ¶ˆç½‘ç»œç›‘å¬å¤±è´¥: ${JSON.stringify(error)}`);
          } else {
            console.log(TAG, 'ç½‘ç»œç›‘å¬å·²å–æ¶ˆ');
          }
        });
      } catch (error) {
        console.error(TAG, `å–æ¶ˆç½‘ç»œç›‘å¬å¼‚å¸¸: ${JSON.stringify(error)}`);
      }
      this.netConnection = null;
    }
  }

  build() {
    Column() {
      Stack({ alignContent : Alignment.TopStart }) {
        TestImageDisplay({ testItem : this.testItem })
        PageTitle({ testItem : this.testItem })
      }

      Scroll() {
        Column() {
          // è­¦å‘Šæç¤º
          Row() {
            Text('âš ï¸ ')
              .fontSize(14)
              .fontColor(Color.Orange)
            Text('HTTPæ¨¡å—ä¸æ”¯æŒç½‘ç»œåˆ‡æ¢æ—¶çš„è‡ªåŠ¨é‡è¿ï¼Œæ¨èä½¿ç”¨ RCP HTTPéªŒè¯')
              .fontSize(12)
              .fontColor(Color.Orange)
          }
          .width('100%')
          .padding(8)
          .backgroundColor('#FFF3E0')
          .borderRadius(5)
          .margin({ top: 5, bottom: 5 })

          // ç½‘ç»œçŠ¶æ€æ˜¾ç¤º
          Row() {
            Text('ç½‘ç»œçŠ¶æ€: ')
              .fontSize(14)
              .fontColor(Color.Gray)
            Text(`${this.networkStatus} (${this.networkType})`)
              .fontSize(14)
              .fontColor(this.networkStatus === 'ç½‘ç»œæ­£å¸¸' ? Color.Green : Color.Orange)
          }
          .width('100%')
          .margin({ bottom: 5 })

          // ç½‘ç»œåˆ‡æ¢æ¬¡æ•°
          if (this.networkSwitchCount > 0) {
            Row() {
              Text('ç½‘ç»œåˆ‡æ¢æ¬¡æ•°: ')
                .fontSize(14)
                .fontColor(Color.Gray)
              Text(`${this.networkSwitchCount}`)
                .fontSize(14)
                .fontColor(Color.Red)
            }
            .width('100%')
            .margin({ bottom: 10 })
          }

          // HTTPè¯·æ±‚é…ç½®åŒºåŸŸ
          Text('HTTPè¯·æ±‚é…ç½®')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .width('100%')
            .margin({ top: 10, bottom: 10 })

          Row() {
            Select(this.typeList)
              .selected(this.selectIndex)
              .value(this.selectValue)
              .font({ size: 12, weight: 300 })
              .fontColor('#182431')
              .selectedOptionFont({ size: 16, weight: 400 })
              .optionFont({ size: 16, weight: 400 })
              .menuAlign(MenuAlignType.START, {dx:0, dy:0})
              .borderRadius('5')
              .width("25%")
              .optionHeight(300)
              .onSelect((index:number, text?: string | undefined)=>{
                console.log(TAG, 'Select:' + index)
                this.selectIndex = index;
                if(text){
                  this.selectValue = text;
                  if (this.selectValue == 'GET') {
                    this.urlValue = 'http://www.baidu.com';
                    this.reqValue = '';
                  } else if (this.selectValue == 'POST') {
                    this.urlValue = 'https://httpbin.org/post';
                    this.reqValue = '{"username": "test","password": "123"}';
                  }
                }
              })
            TextInput({text:this.urlValue}).width('75%').borderRadius('5')
              .onChange((val: string) => {
                this.urlValue = val;
              })
          }
          .width('100%')
          .margin({bottom:10})

          // è¯·æ±‚ä½“é…ç½®
          Text('è¯·æ±‚ä½“é…ç½®')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .width('100%')
            .margin({ bottom: 5 })

          Row() {
            Select(this.reqTypeList)
              .selected(this.reqSelectIndex)
              .value(this.reqSelectValue)
              .font({ size: 12, weight: 300 })
              .fontColor('#182431')
              .selectedOptionFont({ size: 16, weight: 400 })
              .optionFont({ size: 16, weight: 400 })
              .menuAlign(MenuAlignType.START, {dx:0, dy:0})
              .borderRadius('5')
              .width("25%")
              .optionHeight(300)
              .onSelect((index:number, text?: string | undefined)=>{
                console.log(TAG, 'Select:' + index)
                this.reqSelectIndex = index;
                if(text){
                  this.reqSelectValue = text;
                }
              })
            TextInput({text:this.reqValue}).width('75%').borderRadius('5')
              .onChange((val: string) => {
                this.reqValue = val;
              })
          }
          .width('100%')
          .margin({bottom:15})

          // å‘é€æŒ‰é’®å’Œæ¸…ç©ºæŒ‰é’®
          Row() {
            Button('å‘é€è¯·æ±‚')
              .width('45%')
              .backgroundColor(this.isLoading ? Color.Gray : Color.Blue)
              .enabled(!this.isLoading)
              .onClick(() => {
                this.sendHttpRequest();
              })

            Button('æ¸…ç©ºå“åº”æ•°æ®')
              .width('45%')
              .backgroundColor(Color.Orange)
              .onClick(() => {
                this.clearResponse();
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .margin({ bottom: 15 })

          // å“åº”çŠ¶æ€
          if (this.codeValue) {
            Row() {
              Text('å“åº”çŠ¶æ€: ')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
              Text(this.codeValue)
                .fontSize(16)
                .fontColor(this.codeValue.startsWith('2') ? Color.Green : Color.Red)
            }
            .width('100%')
            .margin({ bottom: 10 })
          }

          // å“åº”åŒºåŸŸ
          Text('å“åº”æ•°æ®')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .width('100%')
            .margin({ bottom: 5 })

          TextArea({ text: this.resData })
            .width('100%')
            .height(300)
            .borderRadius(5)
            .backgroundColor(Color.White)
            .margin({ bottom: 20 })
        }
        .width('100%')
        .padding(10)
      }
      .width('95%')
      .height('85%')
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
    }
    .size({ width: ConfigData.WH_100_100, height: ConfigData.WH_100_100 })
    .backgroundColor('#F5F5F5')
  }

  sendHttpRequest() {
    this.isLoading = true;
    this.codeValue = '';
    this.resData = '';

    let httpRequest = http.createHttp();
    
    // ç”¨äºè®¢é˜…HTTPå“åº”å¤´ï¼Œæ­¤æ¥å£ä¼šæ¯”requestè¯·æ±‚å…ˆè¿”å›ã€‚å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦è®¢é˜…æ­¤æ¶ˆæ¯
    httpRequest.on('headersReceive', (header: Object) => {
      console.log(TAG, 'header: ' + JSON.stringify(header));
    });

    class Header {
      public contentType: string;

      constructor(contentType: string) {
        this.contentType = contentType;
      }
    }

    let str2method = (value: string): http.RequestMethod => {
      switch (value) {
        case 'GET':
          return http.RequestMethod.GET;
        case 'HEAD':
          return http.RequestMethod.HEAD;
        case 'POST':
          return http.RequestMethod.POST;
        case 'PUT':
          return http.RequestMethod.PUT;
        case 'DELETE':
          return http.RequestMethod.DELETE;
        case 'TRACE':
          return http.RequestMethod.TRACE;
        case 'OPTIONS':
          return http.RequestMethod.OPTIONS;
        case 'CONNECT':
          return http.RequestMethod.CONNECT;
      }
      return http.RequestMethod.GET;
    }

    let str2head = (): Header => {
      return new Header('application/json')
    }

    let options: http.HttpRequestOptions = {
      method: str2method(this.selectValue),
      header: str2head(),
      extraData: this.reqValue,
      expectDataType: http.HttpDataType.STRING,
      connectTimeout: 60000,
      readTimeout: 60000
    }

    httpRequest.request(this.urlValue, options, (err: BusinessError, data: http.HttpResponse) => {
      this.isLoading = false;
      if (!err) {
        // data.resultä¸ºHTTPå“åº”å†…å®¹ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€è¦è¿›è¡Œè§£æ
        console.log(TAG, 'Result:' + JSON.stringify(data.result));
        this.resData = 'Result:\n' + JSON.stringify(data.result);
        console.log(TAG, 'code:' + JSON.stringify(data.responseCode));
        this.resData += '\ncode:\t' + JSON.stringify(data.responseCode);
        this.codeValue = JSON.stringify(data.responseCode);
        console.log(TAG, 'type:' + JSON.stringify(data.resultType));
        this.resData += '\ntype:\t' + JSON.stringify(data.resultType);
        // data.headerä¸ºHTTPå“åº”å¤´ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€è¦è¿›è¡Œè§£æ
        console.log(TAG, 'header:' + JSON.stringify(data.header));
        this.resData += '\nheader:\n' + JSON.stringify(data.header);
        console.log(TAG, 'cookies:' + JSON.stringify(data.cookies)); // è‡ªAPI version 8å¼€å§‹æ”¯æŒcookie
        // å–æ¶ˆè®¢é˜…HTTPå“åº”å¤´äº‹ä»¶
        httpRequest.off('headersReceive');
        // å½“è¯¥è¯·æ±‚ä½¿ç”¨å®Œæ¯•æ—¶ï¼Œå¼€å‘è€…åŠ¡å¿…è°ƒç”¨destroyæ–¹æ³•ä¸»åŠ¨é”€æ¯è¯¥JavaScript Objectã€‚
        httpRequest.destroy();
      } else {
        console.log(TAG, 'response err: ' + JSON.stringify(err));
        this.resData = 'response err: ' + JSON.stringify(err);
        this.codeValue = 'Error';
        // å–æ¶ˆè®¢é˜…HTTPå“åº”å¤´äº‹ä»¶
        httpRequest.off('headersReceive');
        // å½“è¯¥è¯·æ±‚ä½¿ç”¨å®Œæ¯•æ—¶ï¼Œå¼€å‘è€…åŠ¡å¿…è°ƒç”¨destroyæ–¹æ³•ä¸»åŠ¨é”€æ¯è¯¥JavaScript Objectã€‚
        httpRequest.destroy();
      }
    })
  }

  clearResponse() {
    this.resData = '';
    this.codeValue = '';
  }
}
